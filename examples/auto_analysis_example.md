# Automatic Analysis Example

This example demonstrates the automatic analysis mode of PCAP2Packetdrill, which can analyze a PCAP file and generate test cases for all detected protocols.

## Sample Usage

Given a PCAP file with mixed traffic, you can automatically generate test scripts with:

```bash
pcap2packetdrill mixed_traffic.pcap --auto-analyze --output-dir ./test_scripts
```

## Sample Output

### TCP Test Script (test_scripts/mixed_traffic_tcp.pkt)

```
// TCP Packetdrill script generated by PCAP2Packetdrill
// Client: 192.168.1.2:43210
// Server: 192.168.1.1:80

// ===== Test Preconditions =====
// Preconditions:
// - Create a TCP socket
// - Set appropriate socket options
// - Bind to client address
// - Connect to server

// Initialize the client socket
0 socket(..., SOCK_STREAM, IPPROTO_TCP) = 3

// Socket options
0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
0 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0

// Bind to client address
0 bind(3, ..., ...) = 0
0 connect(3, {sa_family=AF_INET, sin_port=htons(80), sin_addr=192.168.1.1}, ...) = 0

// ===== Packet Trace =====
// This section contains the actual network traffic captured in the PCAP
0.000000 192.168.1.2:43210 --> 192.168.1.1:80 tcp S seq 1000 ack 0 win 64240 mss 1460 sackOK ts val 4522540 ecr 0 wscale 7
0.000123 192.168.1.1:80 --> 192.168.1.2:43210 tcp SA seq 2000 ack 1001 win 65535 mss 1460 sackOK ts val 9045628 ecr 4522540 wscale 7
0.000242 192.168.1.2:43210 --> 192.168.1.1:80 tcp A seq 1001 ack 2001 win 502 ts val 4522541 ecr 9045628
0.001242 192.168.1.2:43210 --> 192.168.1.1:80 tcp PA seq 1001 ack 2001 win 502 ts val 4522542 ecr 9045628, {"0x474554202f20485454502f312e310d0a"}
0.001365 192.168.1.1:80 --> 192.168.1.2:43210 tcp A seq 2001 ack 1018 win 124 ts val 9045629 ecr 4522542
0.050365 192.168.1.1:80 --> 192.168.1.2:43210 tcp PA seq 2001 ack 1018 win 124 ts val 9045630 ecr 4522542, {"0x485454502f312e3120323030204f4b0d0a"}

// ===== Test Postconditions =====
// Postconditions:
// - Ensure connection was established successfully
// - Close socket gracefully

// Gracefully close the connection (if applicable)
+0.100 close(3) = 0
```

### UDP Test Script (test_scripts/mixed_traffic_udp.pkt)

```
// UDP Packetdrill script generated by PCAP2Packetdrill
// Client: 192.168.1.2:53124
// Server: 8.8.8.8:53

// ===== Test Preconditions =====
// Preconditions:
// - Create a UDP socket
// - Set appropriate socket options
// - Bind to client address

// Initialize the client socket
0 socket(..., SOCK_DGRAM, IPPROTO_UDP) = 3

// Socket options
0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0

// Bind to client address
0 bind(3, ..., ...) = 0
0 connect(3, {sa_family=AF_INET, sin_port=htons(53), sin_addr=8.8.8.8}, ...) = 0

// ===== Packet Trace =====
// This section contains the actual network traffic captured in the PCAP
0.000000 192.168.1.2:53124 --> 8.8.8.8:53 udp, {"0x0001010000010000000000000377777706676f6f676c6503636f6d0000010001"}
0.042631 8.8.8.8:53 --> 192.168.1.2:53124 udp, {"0x0001818000010001000000000377777706676f6f676c6503636f6d0000010001c00c00010001000000600004acd910d6"}

// ===== Test Postconditions =====
// Postconditions:
// - Verify expected responses were received
// - Close socket

// Close the socket
+0.100 close(3) = 0
```

### SCTP Test Script (test_scripts/mixed_traffic_sctp.pkt)

```
// SCTP Packetdrill script generated by PCAP2Packetdrill
// Client: 192.168.1.2:38745
// Server: 192.168.1.1:8080

// ===== Test Preconditions =====
// Preconditions:
// - Create an SCTP socket
// - Set appropriate socket options
// - Bind to client address
// - Connect to server

// Initialize the client socket
0 socket(..., SOCK_STREAM, IPPROTO_SCTP) = 3

// Socket options
0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
0 setsockopt(3, IPPROTO_SCTP, SCTP_NODELAY, [1], 4) = 0

// Bind to client address
0 bind(3, ..., ...) = 0
0 connect(3, {sa_family=AF_INET, sin_port=htons(8080), sin_addr=192.168.1.1}, ...) = 0

// ===== Packet Trace =====
// This section contains the actual network traffic captured in the PCAP
0.000000 192.168.1.2:38745 --> 192.168.1.1:8080 sctp tag 0, INIT[flgs=0, tag=123456, a_rwnd=65536, os=10, is=5, tsn=1000]
0.000123 192.168.1.1:8080 --> 192.168.1.2:38745 sctp tag 123456, INIT_ACK[flgs=0, tag=654321, a_rwnd=65536, os=5, is=10, tsn=2000]
0.000242 192.168.1.2:38745 --> 192.168.1.1:8080 sctp tag 654321, COOKIE_ECHO[flgs=0, len=200, val=0x1234567890abcdef]
0.000361 192.168.1.1:8080 --> 192.168.1.2:38745 sctp tag 123456, COOKIE_ACK[flgs=0]

// ===== Test Postconditions =====
// Postconditions:
// - Ensure association was established successfully
// - Close association gracefully

// Close the association
+0.100 close(3) = 0
```

## How It Works

When using the `--auto-analyze` option, PCAP2Packetdrill:

1. **Analyzes the PCAP**: Identifies all protocols and flows in the capture
2. **Identifies Significant Flows**: For each protocol, finds the most complete flows
3. **Determines Endpoints**: Automatically identifies client/server roles
4. **Adds Test Conditions**: 
   - Adds appropriate preconditions based on protocol and flow characteristics
   - Adds postconditions that verify correct behavior
5. **Generates Test Scripts**: Creates separate test scripts for each protocol

## Benefits

- **Comprehensive Testing**: Generate tests for all protocols in a single command
- **Automatic Preconditions**: No need to manually specify socket setup steps
- **Automatic Postconditions**: Proper test verification is added automatically
- **Flow Analysis**: The tool identifies the most significant flows to test

## Customizing the Output

You can customize the output by:

- Providing a custom template file with `--template`
- Specifying endpoints manually with `--client-ip`, `--server-ip`, etc.
- Setting the output directory with `--output-dir`
