# Replay Test Generation Example

This document demonstrates how to use PCAP2Packetdrill's replay test generation functionality to create precise test scripts for complete connection cycles found in PCAP files.

## What are Replay Tests?

Replay tests are Packetdrill scripts that precisely reproduce the network behavior observed in a PCAP file. They are particularly useful for:

- Creating regression tests for observed network behavior
- Reproducing complex protocol interactions
- Testing protocol implementations against real-world packet sequences
- Benchmarking against known good protocol exchanges

Unlike the basic conversion mode, the replay test generator:

1. Identifies complete connection cycles (TCP connections, SCTP associations)
2. Creates a separate test script for each identified cycle
3. Preserves exact timing, sequence numbers, and payloads
4. Generates descriptive test names based on endpoints and connection details

## Usage

### Basic Command

```bash
pcap2packetdrill replay my_capture.pcap
```

This will:
1. Analyze the PCAP file to find complete TCP and SCTP connection cycles
2. Generate a separate test script for each complete cycle
3. Save the scripts to `./replay_tests/` directory

### Specifying an Output Directory

```bash
pcap2packetdrill replay my_capture.pcap --output-dir ./my_tests
```

### Using Custom Templates

```bash
pcap2packetdrill replay my_capture.pcap --template-dir ./my_templates
```

### Example Output

For a PCAP file containing multiple TCP connections and SCTP associations, you might get:

```
Generated replay test scripts:
- ./replay_tests/tcp_192_168_1_2_43210_to_192_168_1_1_80_cycle_1.pkt
- ./replay_tests/tcp_192_168_1_2_43211_to_192_168_1_1_80_cycle_1.pkt
- ./replay_tests/sctp_192_168_1_2_38745_to_192_168_1_1_8080_cycle_1.pkt
...
```

## Sample Replay Test Script

Here's an example of a generated TCP replay test script:

```
// TCP Replay Test Generated by PCAP2Packetdrill
// Generated from complete TCP connection cycle
// Client: 192.168.1.2:43210
// Server: 192.168.1.1:80

// ===== Test Description =====
// This test replays a complete TCP connection cycle including:
// - Connection establishment (SYN, SYN-ACK, ACK)
// - Data exchange
// - Connection termination (FIN sequence)

// ===== Test Preconditions =====
// Preconditions:
// - Create a TCP socket
// - Set appropriate socket options
// - Bind to client address
// - Connect to server

// ===== Socket Setup =====
// Initialize the client socket
0 socket(..., SOCK_STREAM, IPPROTO_TCP) = 3

// Socket options
0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
0 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0

// Bind to client address
0 bind(3, ..., ...) = 0
0 connect(3, {sa_family=AF_INET, sin_port=htons(80), sin_addr=192.168.1.1}, ...) = 0

// ===== Connection Replay =====
// The following section is an exact replay of a captured TCP connection
// All packet timings, sequence numbers, and payload data are preserved
0.000000 192.168.1.2:43210 --> 192.168.1.1:80 tcp S seq 1000 ack 0 win 64240 mss 1460 sackOK ts val 4522540 ecr 0 wscale 7
0.000123 192.168.1.1:80 --> 192.168.1.2:43210 tcp SA seq 2000 ack 1001 win 65535 mss 1460 sackOK ts val 9045628 ecr 4522540 wscale 7
0.000242 192.168.1.2:43210 --> 192.168.1.1:80 tcp A seq 1001 ack 2001 win 502 ts val 4522541 ecr 9045628
0.001242 192.168.1.2:43210 --> 192.168.1.1:80 tcp PA seq 1001 ack 2001 win 502 ts val 4522542 ecr 9045628, {"0x474554202f20485454502f312e310d0a"}
0.001365 192.168.1.1:80 --> 192.168.1.2:43210 tcp A seq 2001 ack 1018 win 124 ts val 9045629 ecr 4522542
0.050365 192.168.1.1:80 --> 192.168.1.2:43210 tcp PA seq 2001 ack 1018 win 124 ts val 9045630 ecr 4522542, {"0x485454502f312e3120323030204f4b0d0a"}
0.100242 192.168.1.2:43210 --> 192.168.1.1:80 tcp FA seq 1018 ack 2018 win 502 ts val 4522642 ecr 9045630
0.100365 192.168.1.1:80 --> 192.168.1.2:43210 tcp FA seq 2018 ack 1019 win 124 ts val 9045680 ecr 4522642
0.100485 192.168.1.2:43210 --> 192.168.1.1:80 tcp A seq 1019 ack 2019 win 502 ts val 4522643 ecr 9045680

// ===== Test Postconditions =====
// Postconditions:
// - Ensure connection was established successfully
// - Verify data was transferred correctly
// - Ensure connection was closed gracefully

// Gracefully close the connection
+0.100 close(3) = 0
```

## How Connection Cycles Are Identified

### TCP Connection Cycles

A complete TCP connection cycle consists of:

1. **Connection Establishment**: SYN, SYN-ACK, ACK handshake
2. **Data Exchange**: Optional data packets in both directions
3. **Connection Termination**: FIN, ACK sequences in both directions

Connections with RST packets are also properly identified and handled.

### SCTP Association Cycles

A complete SCTP association cycle consists of:

1. **Association Establishment**: INIT, INIT-ACK, COOKIE-ECHO, COOKIE-ACK sequence
2. **Data Exchange**: Optional data chunks
3. **Association Termination**: SHUTDOWN sequence

## Benefits of Replay Tests

- **Precise Reproduction**: Exact timings and packet sequences are preserved
- **Complete Connections**: Only full, meaningful protocol interactions are captured
- **Isolated Testing**: Each connection is isolated in its own test script
- **Self-documenting**: Test scripts include details about the original capture
- **Ready to Run**: Scripts are complete and ready to execute with Packetdrill

## Running the Generated Tests

The generated tests can be run directly with Packetdrill:

```bash
packetdrill ./replay_tests/tcp_192_168_1_2_43210_to_192_168_1_1_80_cycle_1.pkt
```
